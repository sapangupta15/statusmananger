<!doctype html>

<html ng-app="app">

<head >
<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.4.3/angular.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.4.3/angular-touch.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.4.3/angular-animate.js"></script>
<script src="http://ui-grid.info/docs/grunt-scripts/csv.js"></script>
<script src="http://ui-grid.info/docs/grunt-scripts/pdfmake.js"></script>
<script src="http://ui-grid.info/docs/grunt-scripts/vfs_fonts.js"></script>
<script src="angular-ui-grid/ui-grid.js"></script>
 <script src="app.js"></script>
<script type="text/javascript" src="web3/dist/web3.js"></script>


<link rel="styleSheet" href="angular-ui-grid/ui-grid.css"/>
<link rel="styleSheet" href="main.css"/>



<script type="text/javascript">
   	
    var Web3 = require('web3');
    var web3 = new Web3();
    web3.setProvider(new web3.providers.HttpProvider("http://localhost:8085"));
   // var code = compiled.TradeStatus.code;
   var code = "6060604052604051610d04380380610d04833981016040528080519060200190919080518201919060200180518201919060200180518201919060200180518201919060200180518201919060200150505b856000600050600001600050819055508460006000506001016000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106100b657805160ff19168380011785556100e7565b828001600101855582156100e7579182015b828111156100e65782518260005055916020019190600101906100c8565b5b50905061011291906100f4565b8082111561010e57600081815060009055506001016100f4565b5090565b50508360006000506002016000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061016957805160ff191683800117855561019a565b8280016001018555821561019a579182015b8281111561019957825182600050559160200191906001019061017b565b5b5090506101c591906101a7565b808211156101c157600081815060009055506001016101a7565b5090565b50508260006000506003016000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061021c57805160ff191683800117855561024d565b8280016001018555821561024d579182015b8281111561024c57825182600050559160200191906001019061022e565b5b509050610278919061025a565b80821115610274576000818150600090555060010161025a565b5090565b50508160006000506004016000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106102cf57805160ff1916838001178555610300565b82800160010185558215610300579182015b828111156102ff5782518260005055916020019190600101906102e1565b5b50905061032b919061030d565b80821115610327576000818150600090555060010161030d565b5090565b50508060006000506005016000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061038257805160ff19168380011785556103b3565b828001600101855582156103b3579182015b828111156103b2578251826000505591602001919060010190610394565b5b5090506103de91906103c0565b808211156103da57600081815060009055506001016103c0565b5090565b50507f8863e458255c600ae3e61be347822f3ee57088c8538b68b5dd2357e682e59e198633604051808381526020018273ffffffffffffffffffffffffffffffffffffffff1681526020019250505060405180910390a15b5050505050506108ba8061044a6000396000f36060604052361561007f576000357c010000000000000000000000000000000000000000000000000000000090048063042d4d501461008157806311f22a84146100fc5780631a3db582146101775780632797a169146101f25780632c21599814610215578063bc3bd0591461026b578063eab39e3e146102e65761007f565b005b61008e6004805050610361565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156100ee5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6101096004805050610423565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156101695780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b61018460048050506104e5565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156101e45780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6101ff60048050506105a7565b6040518082815260200191505060405180910390f35b6102696004808035906020019082018035906020019191908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509090919050506105bf565b005b6102786004805050610736565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156102d85780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6102f360048050506107f8565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156103535780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b602060405190810160405280600081526020015060006000506004016000508054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156104145780601f106103e957610100808354040283529160200191610414565b820191906000526020600020905b8154815290600101906020018083116103f757829003601f168201915b50505050509050610420565b90565b602060405190810160405280600081526020015060006000506005016000508054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156104d65780601f106104ab576101008083540402835291602001916104d6565b820191906000526020600020905b8154815290600101906020018083116104b957829003601f168201915b505050505090506104e2565b90565b602060405190810160405280600081526020015060006000506001016000508054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156105985780601f1061056d57610100808354040283529160200191610598565b820191906000526020600020905b81548152906001019060200180831161057b57829003601f168201915b505050505090506105a4565b90565b600060006000506000016000505490506105bc565b90565b8060006000506001016000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061061457805160ff1916838001178555610645565b82800160010185558215610645579182015b82811115610644578251826000505591602001919060010190610626565b5b5090506106709190610652565b8082111561066c5760008181506000905550600101610652565b5090565b50507f714869395fe61f1b62181a84c746abf3e2e0352a98fceb72add62790bc23e0f76000600050600001600050543383604051808481526020018373ffffffffffffffffffffffffffffffffffffffff168152602001806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156107235780820380516001836020036101000a031916815260200191505b5094505050505060405180910390a15b50565b602060405190810160405280600081526020015060006000506002016000508054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156107e95780601f106107be576101008083540402835291602001916107e9565b820191906000526020600020905b8154815290600101906020018083116107cc57829003601f168201915b505050505090506107f5565b90565b602060405190810160405280600081526020015060006000506003016000508054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108ab5780601f10610880576101008083540402835291602001916108ab565b820191906000526020600020905b81548152906001019060200180831161088e57829003601f168201915b505050505090506108b7565b9056";
    // contract json abi, this is autogenerated using solc CLI
  //   var abi1 = compiled.TradeStatus.info.abiDefinition;
	var tradeContractabi = web3.eth.contract([{"constant":false,"inputs":[],"name":"getFundShortName","outputs":[{"name":"fundShortName","type":"string"}],"type":"function"},{"constant":false,"inputs":[],"name":"getInstrumentId","outputs":[{"name":"instrumentId","type":"string"}],"type":"function"},{"constant":false,"inputs":[],"name":"getTradeStatus","outputs":[{"name":"status","type":"string"}],"type":"function"},{"constant":false,"inputs":[],"name":"getTradeId","outputs":[{"name":"tradeId","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"status","type":"string"}],"name":"updateStatus","outputs":[],"type":"function"},{"constant":false,"inputs":[],"name":"getTradeDate","outputs":[{"name":"tradeDate","type":"string"}],"type":"function"},{"constant":false,"inputs":[],"name":"getTradingDesk","outputs":[{"name":"tradeDesk","type":"string"}],"type":"function"},{"inputs":[{"name":"tradeId","type":"uint256"},{"name":"tradeStatus","type":"string"},{"name":"tradeDate","type":"string"},{"name":"tradeDesk","type":"string"},{"name":"fundShortName","type":"string"},{"name":"instrumentId","type":"string"}],"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"tradeId","type":"uint256"},{"indexed":false,"name":"recipient","type":"address"}],"name":"Received","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"tradeId","type":"uint256"},{"indexed":false,"name":"recipient","type":"address"},{"indexed":false,"name":"status","type":"string"}],"name":"StatusUpdated","type":"event"}]);

    var myContract;
	
var traderegistrarContractabi = web3.eth.contract([{"constant":true,"inputs":[{"name":"_addr","type":"address"}],"name":"name","outputs":[{"name":"o_tradeId","type":"string"}],"type":"function"},{"constant":false,"inputs":[{"name":"_tradeId","type":"string"}],"name":"disown","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"_tradeId","type":"string"},{"name":"_newOwner","type":"address"}],"name":"setOwner","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"_tradeId","type":"string"}],"name":"addr","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":true,"inputs":[{"name":"_tradeId","type":"string"}],"name":"subRegistrar","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"_tradeId","type":"string"},{"name":"_a","type":"address"}],"name":"setAddress","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"_tradeId","type":"string"}],"name":"reserve","outputs":[],"type":"function"},{"constant":false,"inputs":[],"name":"Registrar","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"_tradeId","type":"string"}],"name":"setName","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"_tradeId","type":"string"},{"name":"_registrar","type":"address"}],"name":"setSubRegistrar","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"_tradeId","type":"string"}],"name":"content","outputs":[{"name":"","type":"bytes32"}],"type":"function"},{"constant":true,"inputs":[{"name":"_tradeId","type":"string"}],"name":"owner","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"_tradeId","type":"string"},{"name":"_content","type":"bytes32"}],"name":"setContent","outputs":[],"type":"function"},{"anonymous":false,"inputs":[{"indexed":false,"name":"name","type":"string"}],"name":"Changed","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"addr","type":"address"},{"indexed":false,"name":"name","type":"string"}],"name":"ReverseChanged","type":"event"}]);

var traderegistrarContract = traderegistrarContractabi.at("0x4d97a70490e173781ac3a8604fb0b103c9432eb0");

    function createTradeStatusContract(row) {
    // create contract
    tradeContractabi.new(row["FIL TradeId"],row["Status"],row["Trade Creation Date"],row["Trading Desk"],row["Fund Short Name"],row["Instrument Id"],{data: code,from: web3.eth.accounts[0],gas: 3000000}, function (err, contract) {
            if(err) {
                console.error(err);
                return;
            // callback fires twice, we only want the second call when the contract is deployed
            } else if(contract.address){

                //myContract = contract;
                console.log('address: ' + contract.address);
				console.log('tradeId ' + contract.getTradeId.call());
				var tradeId = 'tradeId' + contract.getTradeId.call();
			//	traderegistrarContract.reserve.sendTransaction(tradeId,{from: web3.eth.accounts[0]});
				console.log('address: ' + contract.address);
				traderegistrarContract.setAddress.sendTransaction('tradeId' + contract.getTradeId.call(), contract.address, true,{from: web3.eth.accounts[0]});
            }
        });
    }

    function updateTradeStatus(status) {
	    traderegistrarContract.reserve.sendTransaction(myContract.getTradeId.call(),{from: web3.eth.accounts[0]});
        var res = myContract.updateStatus.sendTransaction(status,{from: web3.eth.accounts[0]});
		document.getElementById('result').innerText = myContract.getTradeStatus.call();
    }
	
	function getStatus() {
         // get trade Status
		document.getElementById('result').innerText = myContract.getTradeStatus.call();
	}
</script>
</head>
<body>
    <h1>Trading System</h1>
	<div ng-controller="MainCtrl">
	<button type="button" class="btn btn-success" ng-click="send()">Book</button>
  <div ui-grid="trades" ui-grid-selection class="ui-grid"></div>
</div>
</body>
</html>

